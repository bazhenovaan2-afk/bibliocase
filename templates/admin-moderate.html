<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Модерация кейсов - BiblioCase</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default-settings.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-moderate.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
    <style>
        .admin-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--background);
        }
        
        .admin-main {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            width: 100%;
        }
        
        .admin-title {
            font-size: 1.75rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            text-align: center;
        }
        
        .cases-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .case-item {
            background-color: var(--surface);
            padding: 1.25rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .case-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .case-info {
            flex: 1;
        }
        
        .case-info h3 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--text);
            line-height: 1.3;
        }
        
        .case-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        
        .case-preview-text {
            color: var(--text);
            line-height: 1.6;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .case-preview-img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
        }
        
        /* Кнопки действий */
        .case-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }
        
        .btn-approve,
        .btn-reject {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
        }
        
        .btn-approve {
            background-color: #28a745;
            color: white;
        }
        
        .btn-approve:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-approve:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-approve.approved {
            background-color: #6c757d;
        }
        
        .btn-reject {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-reject:hover:not(:disabled) {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .btn-reject:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-reject.rejected {
            background-color: #6c757d;
        }
        
        /* Состояния загрузки */
        .loading-indicator, .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        /* Адаптивность */
        @media (min-width: 768px) {
            .admin-main {
                padding: 3rem 2rem;
            }
            
            .admin-title {
                font-size: 2rem;
                text-align: left;
            }
            
            .case-item {
                flex-direction: row;
                padding: 1.5rem;
                gap: 2rem;
            }
            
            .case-actions {
                flex-direction: column;
                min-width: 160px;
                width: auto;
            }
            
            .case-preview-img {
                max-width: 250px;
                max-height: 180px;
            }
        }
        
        @media (max-width: 480px) {
            .case-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .case-info h3 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Вставляем общую навигацию -->
        {% include 'nav-header.html' %}

        <main class="admin-main">
            <div class="admin-content">
                <h2 class="admin-title">Кейсы на модерации</h2>
                
                <div id="loading" class="loading-indicator" style="display: none;">
                    <p>Загрузка кейсов...</p>
                </div>

                <div id="empty-state" class="empty-state" style="display: none;">
                    <p>Нет кейсов на модерации</p>
                </div>

                <div id="cases-list" class="cases-list"></div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api';
        const currentUserId = localStorage.getItem('user_id');
        const username = localStorage.getItem('username');
        const isAdmin = localStorage.getItem('is_admin') === 'true';

        // Проверка прав
        if (!currentUserId || !isAdmin) {
            window.location.href = '{{ url_for("index") }}';
        }

        function logout() {
            localStorage.clear();
            window.location.href = '{{ url_for("index") }}';
        }

        async function loadPendingCases() {
            const loading = document.getElementById('loading');
            const list = document.getElementById('cases-list');
            const empty = document.getElementById('empty-state');
            
            loading.style.display = 'block';
            list.innerHTML = '';
            empty.style.display = 'none';

            try {
                // ИСПРАВЛЕНИЕ: Безопасный URL
                const userIdParam = (currentUserId && currentUserId !== 'undefined') ? currentUserId : '';
                const response = await fetch(`${API_URL}/pending-cases?user_id=${userIdParam}`);
                
                if (response.ok) {
                    const cases = await response.json();
                    loading.style.display = 'none';

                    if (cases.length === 0) {
                        empty.style.display = 'block';
                        return;
                    }

                    cases.forEach(caseItem => {
                        const item = document.createElement('div');
                        item.className = 'case-item';
                        
                        // Открытие кейса при клике
                        item.onclick = function(e) {
                            // Если кликнули не на кнопку
                            if (!e.target.closest('.case-actions')) {
                                window.open(`/case/${caseItem.id}`, '_blank');
                            }
                        };
                        
                        let imageHtml = '';
                        if (caseItem.image_path) {
                            imageHtml = `<img src="${caseItem.image_path}" alt="Image" class="case-preview-img">`;
                        }

                        item.innerHTML = `
                            <div class="case-info">
                                <h3>${escapeHtml(caseItem.title)}</h3>
                                <div class="case-meta">
                                    <span>Категория: ${escapeHtml(caseItem.category)}</span>
                                    <span>Автор: ${escapeHtml(caseItem.username)}</span>
                                    <span>Дата: ${new Date(caseItem.created_at).toLocaleDateString()}</span>
                                </div>
                                <div class="case-preview-text">
                                    ${escapeHtml(caseItem.content.substring(0, 200))}...
                                </div>
                                ${imageHtml}
                            </div>
                            <div class="case-actions">
                                <button class="btn-approve" onclick="approveCase(${caseItem.id}, this)">✓ Одобрить</button>
                                <button class="btn-reject" onclick="rejectCase(${caseItem.id}, this)">✕ Отклонить</button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    loading.style.display = 'none';
                    alert('Ошибка загрузки данных');
                }
            } catch (error) {
                console.error('Error:', error);
                loading.style.display = 'none';
            }
        }

        async function approveCase(caseId, button) {
            button.disabled = true;
            button.textContent = 'Одобряется...';

            try {
                const response = await fetch(`${API_URL}/cases/${caseId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(currentUserId) })
                });

                if (response.ok) {
                    button.textContent = '✓ Одобрено';
                    button.classList.add('approved');
                    setTimeout(() => {
                        loadPendingCases();
                    }, 1000);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Ошибка');
                    button.disabled = false;
                    button.textContent = '✓ Одобрить';
                }
            } catch (error) {
                console.error(error);
                button.disabled = false;
                button.textContent = '✓ Одобрить';
            }
        }

        async function rejectCase(caseId, button) {
            if (!confirm('Отклонить этот кейс? Кейс будет удален.')) return;

            button.disabled = true;
            button.textContent = 'Отклоняется...';

            try {
                const response = await fetch(`${API_URL}/cases/${caseId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(currentUserId) })
                });

                if (response.ok) {
                    button.textContent = '✕ Отклонено';
                    button.classList.add('rejected');
                    setTimeout(() => {
                        loadPendingCases();
                    }, 1000);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Ошибка');
                    button.disabled = false;
                    button.textContent = '✕ Отклонить';
                }
            } catch (error) {
                console.error(error);
                button.disabled = false;
                button.textContent = '✕ Отклонить';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadPendingCases();
    </script>
</body>
</html>