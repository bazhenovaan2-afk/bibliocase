<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Просмотр кейса - BiblioCase</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default-settings.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
    <style>
        /* Контейнер страницы */
        .case-detail-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--background);
        }
        
        /* Основной контент */
        .case-detail-main {
            flex: 1;
            padding: 1.5rem 1rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Контент кейса */
        .case-content {
            background-color: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 1rem;
        }
        
        /* Кнопка назад */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: transparent;
            border: 2px solid var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            text-decoration: none !important;
            width: 100%;
            justify-content: center;
        }
        
        .back-button:hover {
            border-color: var(--primary);
            color: var(--primary);
            text-decoration: none !important;
        }
        
        /* ЗАГОЛОВОК И КАТЕГОРИЯ - ИСПРАВЛЕНО! */
        .case-header {
            margin-bottom: 2rem;
        }
        
        .case-category {
            display: inline-block;
            background-color: rgba(30, 95, 91, 0.1);
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .case-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary-dark);
            line-height: 1.2;
            margin-bottom: 1rem;
        }
        
        /* Мета информация */
        .case-meta {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        
        .case-meta-left {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .case-author {
            font-weight: 500;
            font-size: 1rem;
        }
        
        #case-author {
            color: var(--primary);
        }
        
        .case-date {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        /* Кнопка лайка */
        .like-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--background);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            text-decoration: none !important;
        }
        
        .like-button:hover {
            border-color: var(--primary);
            color: var(--primary);
            text-decoration: none !important;
        }
        
        .like-button.liked {
            background-color: rgba(30, 95, 91, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .like-button svg {
            width: 20px;
            height: 20px;
        }
        
        /* Изображение кейса */
        .case-image-container {
            width: 100%;
            max-height: 500px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .case-image-container img {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            display: block;
        }
        
        /* Текст кейса */
        .case-text {
            margin-top: 1.5rem;
        }
        
        .case-content-text {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Состояния загрузки */
        .loading-indicator,
        .error-message {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }
        
        .error-message a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
        }
        
        .error-message a:hover {
            text-decoration: underline;
        }
        
        /* Футер */
        .case-detail-footer {
            margin-top: auto;
            padding: 1.5rem 1rem;
            text-align: center;
            color: var(--text-muted);
            background-color: var(--surface);
            border-top: 1px solid var(--border);
        }
        
        /* Адаптивность */
        @media (min-width: 768px) {
            .case-detail-main {
                padding: 2.5rem 2rem;
            }
            
            .case-content {
                padding: 2.5rem;
            }
            
            .case-title {
                font-size: 2.5rem;
            }
            
            .case-meta {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .case-meta-left {
                flex-direction: row;
                align-items: center;
                gap: 1.5rem;
            }
            
            .case-category {
                font-size: 1rem;
            }
            
            .case-content-text {
                font-size: 1.1rem;
            }
            
            .back-button {
                width: auto;
                justify-content: flex-start;
            }
            
            .like-button {
                width: fit-content;
            }
        }
        
        @media (min-width: 1024px) {
            .case-detail-main {
                padding: 3rem;
            }
            
            .case-content {
                padding: 3rem;
            }
            
            .case-title {
                font-size: 3rem;
            }
        }
        
        /* Для очень маленьких экранов */
        @media (max-width: 480px) {
            .case-title {
                font-size: 1.5rem;
            }
            
            .case-image-container {
                max-height: 300px;
            }
            
            .case-image-container img {
                max-height: 300px;
            }
            
            .case-content-text {
                font-size: 0.95rem;
            }
            
            .case-category {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
            }
            
            .case-author {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 360px) {
            .case-title {
                font-size: 1.3rem;
            }
            
            .case-image-container {
                max-height: 250px;
            }
            
            .case-image-container img {
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="case-detail-container">
        <!-- Вставляем общую навигацию -->
        {% include 'nav-header.html' %}

        <!-- Основной контент -->
        <main class="case-detail-main">
            <div class="case-content">
                <button class="back-button" onclick="window.location.href='{{ url_for('collections') }}'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Назад к коллекциям
                </button>
                
                <div id="loading" class="loading-indicator">Загрузка...</div>
                <div id="error-message" class="error-message" style="display: none;">
                    <p>Ошибка загрузки кейса</p>
                    <a href="{{ url_for('collections') }}">Вернуться к коллекциям</a>
                </div>

                <article id="case-article" class="case-article" style="display: none;">
                    <div class="case-header">
                        <div class="case-category" id="case-category"></div>
                        <h1 class="case-title" id="case-title"></h1>
                    </div>
                    
                    <div class="case-meta">
                        <div class="case-meta-left">
                            <div class="author">Автор: <strong id="case-author"></strong></div>
                            <div class="case-date" id="case-date"></div>
                        </div>
                        <button id="like-button" class="like-button" onclick="toggleLike()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            <span id="like-count">0</span>
                        </button>
                    </div>

                    <div id="case-image-container" class="case-image-container"></div>
                    <div class="case-text">
                        <div id="case-text" class="case-content-text"></div>
                    </div>
                </article>
            </div>
        </main>

        <!-- Футер -->
        <footer class="case-detail-footer">
            <p>&copy; 2025 BiblioCase. Все права защищены.</p>
        </footer>
    </div>

    <script>
        const API_URL = '/api';
        const currentUserId = localStorage.getItem('user_id');
        const username = localStorage.getItem('username');
        
        // Получаем ID кейса из URL
        const pathParts = window.location.pathname.split('/');
        const caseId = pathParts[pathParts.length - 1];

        let currentCaseData = null;

        async function loadCase() {
            try {
                const userIdParam = (currentUserId && currentUserId !== 'undefined') ? currentUserId : '';
                const response = await fetch(`${API_URL}/cases/${caseId}?user_id=${userIdParam}`);
                
                if (response.ok) {
                    const data = await response.json();
                    currentCaseData = data;
                    renderCase(data);
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error:', error);
                showError();
            }
        }

        function renderCase(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('case-article').style.display = 'block';
            
            // КАТЕГОРИЯ ТЕПЕРЬ ВИДНА - исправлено!
            document.getElementById('case-category').textContent = data.category;
            document.getElementById('case-title').textContent = data.title;
            document.getElementById('case-text').innerHTML = data.content.replace(/\n/g, '<br>');
            document.getElementById('case-author').textContent = '@' + data.username;
            document.getElementById('case-date').textContent = new Date(data.created_at).toLocaleDateString();
            document.getElementById('like-count').textContent = data.likes_count;

            if (data.image_path) {
                const imgContainer = document.getElementById('case-image-container');
                imgContainer.innerHTML = `<img src="${data.image_path}" alt="${data.title}" loading="lazy">`;
            }

            const likeButton = document.getElementById('like-button');
            const svg = likeButton.querySelector('svg');
            if (data.is_liked) {
                likeButton.classList.add('liked');
                svg.setAttribute('fill', 'currentColor');
            }
        }

        async function toggleLike() {
            if (!currentUserId || currentUserId === 'undefined') {
                window.location.href = '{{ url_for("login_page") }}';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cases/${caseId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(currentUserId) })
                });

                const data = await response.json();

                if (response.ok) {
                    const likeButton = document.getElementById('like-button');
                    const likeCount = document.getElementById('like-count');
                    const svg = likeButton.querySelector('svg');
                    
                    currentCaseData.is_liked = data.is_liked;
                    currentCaseData.likes_count = data.likes_count;
                    
                    if (data.is_liked) {
                        likeButton.classList.add('liked');
                        svg.setAttribute('fill', 'currentColor');
                    } else {
                        likeButton.classList.remove('liked');
                        svg.setAttribute('fill', 'none');
                    }
                    likeCount.textContent = data.likes_count;
                }
            } catch (error) {
                console.error('Ошибка при лайке:', error);
            }
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
        }
        
        loadCase();
    </script>
</body>
</html>